#!/bin/bash
# shellcheck disable=SC2154
# (silence shellcheck wrt $cam1 environment variable)

if [[ $# -lt 4 ]];  then  echo "Format: [narrow=1] [cam1=1] $0 width height framerate ms [us]"; exit;  fi
if [[ "$(( $1 % 2 ))" -eq 1 ]];  then echo "width has to be even"; exit;  fi
if [[ "$(( $2 % 2 ))" -eq 1 ]];  then echo "height has to be even"; exit;  fi

export SHTR=""; if [[ $# -gt 4 ]]; then SHTR="--shutter"; fi
export workaround=""; if [[ "" != "$(grep '=bookworm' /etc/os-release)" ]]; then workaround="--no-raw"; fi
export d=10; if [[ "" != "$(grep "Revision.*: ...17.$" /proc/cpuinfo)" ]]; then if [[ "$cam1" == "" ]]; then d=10; else d=11; fi; fi

# Check and create /dev/shm if needed (without sudo)
if [[ ! -d "/dev/shm" ]]; then
    echo "INFO: /dev/shm not available, using /tmp for markers file" >&2
    MARKERS_DIR="/tmp"
else
    # Test write permissions to /dev/shm
    if ! touch "/dev/shm/test_write_$$" 2>/dev/null; then
        echo "INFO: /dev/shm not writable, using /tmp for markers file" >&2
        echo "HINT: To fix this, run: sudo chmod 1777 /dev/shm" >&2
        MARKERS_DIR="/tmp"
    else
        rm -f "/dev/shm/test_write_$$"
        MARKERS_DIR="/dev/shm"
    fi
fi

# Create markers file for LSL synchronization (simple version)
MARKERS_FILE="$MARKERS_DIR/camera_markers.txt"
echo "Starting recording" > "$MARKERS_FILE"
echo "CONFIG: ${1}x${2}@${3}fps" >> "$MARKERS_FILE"
chmod 666 "$MARKERS_FILE" 2>/dev/null || true
echo "Markers file: $MARKERS_FILE" >&2

# Check if user is in video group (camera access)
if ! groups | grep -q "video\|camera"; then
    echo "WARNING: User not in 'video' group. Camera access may fail." >&2
    echo "HINT: Add user to video group: sudo usermod -a -G video \$USER" >&2
    echo "HINT: Then logout and login again for changes to take effect" >&2
fi

# ENHANCEMENT: Dynamic device detection with unlimited scalability
# Get all available media devices dynamically (no hardcoded limits)
MEDIA_DEVICES=($(ls /dev/media* 2>/dev/null | sort -V))

if [ ${#MEDIA_DEVICES[@]} -eq 0 ]; then
    echo "ERROR: No media devices found in /dev/media*" >&2
    echo "HINT: Make sure camera is connected and drivers are loaded" >&2
    echo "HINT: Try: lsmod | grep imx296" >&2
    exit 1
fi

echo "Found ${#MEDIA_DEVICES[@]} media device(s): ${MEDIA_DEVICES[*]}" >&2

# Check media device permissions
for media_dev in "${MEDIA_DEVICES[@]}"; do
    if [[ ! -r "$media_dev" ]]; then
        echo "WARNING: Cannot read $media_dev (permission denied)" >&2
        echo "HINT: Check device permissions or add user to video group" >&2
    fi
done

# Try to configure each available media device
CONFIGURED=false
IMX296_ENTITY=""

# First, discover the actual IMX296 entity name
echo "Discovering IMX296 entity names..." >&2
for media_dev in "${MEDIA_DEVICES[@]}"; do
    echo "Scanning $media_dev for IMX296 entities:" >&2
    # Get all entities and look for IMX296
    entities=$(media-ctl -d "$media_dev" -p 2>/dev/null | grep -i "imx296" | head -5)
    if [[ -n "$entities" ]]; then
        echo "Found IMX296 entities in $media_dev:" >&2
        echo "$entities" >&2
        # Extract the first entity name
        IMX296_ENTITY=$(echo "$entities" | head -1 | sed -n "s/.*entity \([0-9]*\): \([^(]*\).*/\2/p" | xargs)
        if [[ -n "$IMX296_ENTITY" ]]; then
            echo "Will use entity: '$IMX296_ENTITY'" >&2
            break
        fi
    else
        echo "No IMX296 entities found in $media_dev" >&2
    fi
done

# If no IMX296 entity found, try common alternatives
if [[ -z "$IMX296_ENTITY" ]]; then
    echo "No IMX296 entity discovered, trying common entity names..." >&2
    # Try different possible entity names
    for media_dev in "${MEDIA_DEVICES[@]}"; do
        for entity in "imx296 $d-001a" "imx296" "imx296-$d" "sensor" "camera"; do
            echo "Testing entity '$entity' on $media_dev..." >&2
            if media-ctl -d "$media_dev" -e "$entity" 2>/dev/null; then
                IMX296_ENTITY="$entity"
                echo "Found working entity: '$entity'" >&2
                break 2
            fi
        done
    done
fi

# If still no entity, show available entities for debugging
if [[ -z "$IMX296_ENTITY" ]]; then
    echo "Could not find IMX296 entity. Available entities:" >&2
    for media_dev in "${MEDIA_DEVICES[@]}"; do
        echo "=== $media_dev ===" >&2
        media-ctl -d "$media_dev" -p 2>/dev/null | grep "entity" | head -10 >&2
    done
    echo "ERROR: No IMX296 entity found on any media device" >&2
    exit 1
fi

# Now try to configure using the discovered entity
for media_dev in "${MEDIA_DEVICES[@]}"; do
    echo "Trying media device $media_dev with entity '$IMX296_ENTITY'" >&2
    if media-ctl -d "$media_dev" --set-v4l2 "'$IMX296_ENTITY':0 [fmt:SBGGR10_1X10/${1}x${2} crop:($(( (1440 - $1) / 2 )),$(( (1088 - $2) / 2 )))/${1}x$2]" -v 2>/dev/null; then
        echo "Successfully configured media device: $media_dev with entity: $IMX296_ENTITY" >&2
        echo "MEDIA_DEVICE: $media_dev" >> "$MARKERS_FILE"
        echo "ENTITY: $IMX296_ENTITY" >> "$MARKERS_FILE"
        CONFIGURED=true
        break
    else
        echo "Failed to configure $media_dev with entity '$IMX296_ENTITY', trying next..." >&2
    fi
done

if [ "$CONFIGURED" = false ]; then
    echo "ERROR: Could not configure any media device" >&2
    echo "HINT: Ensure user has camera permissions (video group)" >&2
    echo "HINT: Check if camera drivers are loaded: lsmod | grep imx296" >&2
    echo "HINT: Try running: sudo usermod -a -G video \$USER" >&2
    exit 1
fi

libcamera-hello --list-cameras ; echo
rm -f "$MARKERS_DIR/tst.pts"

if [[ "" != "$(grep "Revision.*: ...17.$" /proc/cpuinfo)" ]]
then
  rpicam-vid "$workaround" ${cam1:+--camera 1} --width "$1" --height "$2" --denoise cdn_off --framerate "$3" -t "$4" "$SHTR" "$5" -o "$MARKERS_DIR/tst${cam1:+1}.mp4" -n ; echo 
  ~/venv/bin/python ~/rpicam-apps/utils/timestamp.py --plot ${narrow:+--narrow} "$MARKERS_DIR/tst${cam1:+1}.mp4"
else
  libcamera-vid "$workaround" --width "$1" --height "$2" --denoise cdn_off --framerate "$3" --save-pts "$MARKERS_DIR/tst.pts" -t "$4" "$SHTR" "$5" -o "$MARKERS_DIR/tst.h264" -n ; echo 
  rm -f tstamps.csv && ptsanalyze "$MARKERS_DIR/tst.pts"
fi
